Linaro downloads license protection
===================================

Linaro builds sometimes contain "binary blobs"—pieces of binary-only code
which enable extra features like accelerated graphics or multimedia.
These pieces are distributed under a separate license, and downloading
images or collections containing them requires some sort of license
protection.

This code provides such license protection on the hosting web server:
other parts of infrastructure need to properly integrate with it (see
eg. android-build.linaro.org section).  At the moment, it's implemented as
a click-through license acceptance on the Apache side.

To ensure and prove this keeps working, we are also using automated tests
with this code.


Setup
-----

This tree is the base for snapshots.linaro.org and releases.linaro.org www
roots as served by Apache.  It makes heavy use of mod_rewrite from within
the .htaccess file.

Currently, all directories/files containing either 'origen' or 'snowball'
in the URL path are protected with appropriate license (Samsung or ST-E)
click-through.

Dependencies
............

libapache2-mod-php5

Testing:
  phpunit, python 2.7, testrepository (>=0.0.6), python-html2text,
  python-subunit, python-beautifulsoup

Recent (as of 2012-05-08) Ubuntu/Debian releases have a broken phpunit
package and thus require installation of phpunit through PEAR:

  $ sudo apt-get install php-pear
  $ sudo pear config-set auto_discover 1
  $ sudo pear install pear.phpunit.de/PHPUnit


Technical details
-----------------

releases.linaro.org
...................

Root directory for releases.linaro.org includes .htaccess and licenses/*.
It has mod_rewrite enabled.

It allows a few hard-coded hosts to bypass the click-through protection,
by their IPs:

 * android-build.linaro.org (50.17.250.69)
 * validation.linaro.org (213.123.120.124)

Currently hosted on mombin.canonical.com.


snapshots.linaro.org
....................

Same basic set-up as releases.linaro.org.

Further, to allow android-build.linaro.org to push to snapshots.linaro.org
www area directly, we set-up two different users on the system with SSH keys:

 * android-build-linaro:

   chrooted to /srv/snapshots.linaro.org/www/android/ and allows sftp
   access to push files over;  home directory

 * android-build-linaro-trigger:

   limited to executing only a single command through
   /etc/ssh/user-authorized-keys/android-build-linaro-trigger

     command="/home/android-build-linaro-trigger/scripts
              /trigger-android-build-linaro.sh ${SSH_ORIGINAL_COMMAND#* }"

   (this passes the arguments received from the remote end as well)

   This script does a sudo to 'android-build-linaro' and then runs

     /home/android-build-linaro/scripts/jenkins-post-sftp.sh

   script which moves files from /android/.tmp/ into appropriate
   build directory.  It expects "build_name/build_number" as command
   line parameters.

android-build.linaro.org
........................

Runs Jenkins and uses SFTP plugin to access the above two users.  Private
keys live in

  /home/ubuntu/snapshots-sync/snapshots-sync — android-build-linaro
  /home/ubuntu/snapshots-sync/snapshots-filemove — android-build-linaro-trigger

To ensure serialization of steps, and allow LAVA submission, these happen as
build steps, and not as publishing steps.


Build-Info support
------------------

BUILD-INFO.txt format
.....................
Format-Version: 0.1
  Version of the BUILD-INFO format.
Files-Pattern: *.img, *.tar.bz2
  Filename patterns are specified using a simplified shell glob syntax. Will
  be used to identify protected files.
Build-Name: landing-snowball
  Would be unique over all the builds of the same type. For now used as
  a placeholder and will be ignored. To be added later by build services?
Theme: stericsson
  Theme name for selecting proper theming on download and license pages,
  vendor name.
License-Type: open/protected
  open - Open builds. No license page is displayed.
  protected - EULA protected builds. If 'OpenID-Launchpad-Teams' is defined
    then OpenID protection is used, otherwise simple Accept/Decline license
    page is displayed before accessing protected files.
OpenID-Launchpad-Teams: linaro
  LP team names, members of are allowed to access protected files. No OpenID
  protection if absent.
Collect-User-Data: yes/no
  Defaults to 'no' if not present. If the field is set to 'yes' then
  Name and E-Mail (some other fields?) fields are asked to be filled. If it
  will be needed in the future it could be expanded with
  'Collect-User-Data-Fields' field later or any other approach.
License-Text: EULA full text included in BUILD-INFO.txt

- If line begins with space character ' ' it is treated as a part of last found
variable which turns as multiline variable and is appended to it.
- Variable names are case insensitive.

License protection script takes information from the BUILD-INFO.txt file placed
in the same directory as artifacts, finds 'Files-Pattern' block corresponding
to requested file and applies rules from that block to download procedure.
If no BUILD-INFO.txt is found it falls back to per-file/per-directory EULA
protection.


Tests
-----

Testing infrastructure is based on 'testrepository' and requires at least
Python and Apache2:

  $ testr init
  $ testr run

Test plans
..........

To run the test plans from testplans/ subdirectory against
snapshots.linaro.org and releases.linaro.org, execute the following:

  $ testr init
  $ testr run testplans.test_suite

These tests require an internet connection.

Tests for PHP license-matching logic
....................................

Unit tests for the license-matching logic written in PHP are automatically
ran as part of the full test suite (testr run).  However, for a more
detailed output, you may need to run phpunit directly.

To run the tests separately, do the following:

  $ phpunit tests/LicenseHelperTest
