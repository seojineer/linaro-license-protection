IndexIgnore HEADER* licenses *EULA* BUILD-INFO.txt
IndexOptions FancyIndexing HTMLTable

RewriteEngine On

## LP_DOWNLOAD_DIR is set to the dir from REQUEST_URI
## or to the dir containig file form REQUEST_URI
RewriteCond %{REQUEST_FILENAME} !.*/licenses/.*
RewriteCond %{REQUEST_FILENAME} (.*\/)(.*)$
RewriteRule (.*\/)(.*) - [E=LP_DOWNLOAD_DIR:%1]

## CO_DOMAIN is set to host name or host address
## without port number for use in cookie domain
RewriteCond %{SERVER_PORT} !^80$ [OR]
RewriteCond %{SERVER_PORT} !^443$
RewriteCond %{HTTP_HOST} ^([^:]*)$
RewriteRule .* - [E=CO_DOMAIN:%1]

RewriteCond %{SERVER_PORT} !^80$ [OR]
RewriteCond %{SERVER_PORT} !^443$
RewriteCond %{HTTP_HOST} ^([^:]*):(.*)$
RewriteRule .* - [E=CO_DOMAIN:%1]

## Let internal hosts through always.
# android-build.linaro.org.
RewriteCond %{REMOTE_ADDR} 50.17.250.69 [OR]
# validation.linaro.org.
RewriteCond %{REMOTE_ADDR} 82.69.11.23
RewriteRule .* - [L]

## If license file is requested, and a download has been requested previously,
## pass through to the license file.
RewriteCond %{REQUEST_URI} /licenses/ste.html$ [OR]
RewriteCond %{REQUEST_URI} /licenses/samsung.html$ [OR]
RewriteCond %{REQUEST_URI} /licenses/linaro.html$ [OR]
RewriteCond %{REQUEST_URI} /licenses/nolicense.html$ [OR]
RewriteCond %{REQUEST_URI} /licenses/license.php$
RewriteCond %{HTTP_COOKIE} downloadrequested
RewriteCond %{HTTP_COOKIE} !licenseaccepted=true
RewriteRule .* - [L]

## When license files are requested directly, forward to
## the snapshots.l.o site itself.
RewriteCond %{REQUEST_URI} /licenses/linaro.html$ [OR]
RewriteCond %{REQUEST_URI} /licenses/samsung.html$ [OR]
RewriteCond %{REQUEST_URI} /licenses/ste.html$ [OR]
RewriteCond %{REQUEST_URI} /licenses/license.php$
RewriteCond %{HTTP_COOKIE} !downloadrequested=(.*)
RewriteRule .* / [R,L]

## If there is a cookie indicating license has been accepted, pass through.
## Unset it to be able to process several protected files in the same dir
RewriteCond %{HTTP_COOKIE} licenseaccepted=true
RewriteCond %{HTTP_COOKIE} downloadrequested=([^\;]*\/)([^/\;]*)
RewriteRule .* - [CO=licenseaccepted:INVALID:.%{ENV:CO_DOMAIN}:-1:%1,L]

## When license is accepted, set the cookie.
RewriteCond %{REQUEST_URI} licenses/.*-accepted.html$
RewriteCond %{HTTP_COOKIE} downloadrequested=([^\;]*\/)([^/\;]*)
RewriteRule .* %1%2 [CO=licenseaccepted:true:.%{ENV:CO_DOMAIN}:5:%1,R,L]

## When license is being declined, show the notice that you have to accept it.
RewriteCond %{REQUEST_URI} licenses/.*-declined.html$
RewriteCond %{HTTP_COOKIE} downloadrequested=(.*)
RewriteRule .* /licenses/nolicense.html [L]

## Exception for images.
RewriteCond %{REQUEST_URI} /favicon.ico [OR]
RewriteCond %{REQUEST_URI} .*\.png
RewriteRule .* - [L]

## Exception for restricted area
RewriteCond %{REQUEST_URI} .*openid.* [OR]
RewriteCond %{REQUEST_URI} .*restricted.* [OR]
RewriteCond %{REQUEST_URI} .*private.*
RewriteRule .* - [L]

## Pass through any non-protected dirs.
RewriteCond %{REQUEST_FILENAME} -d
RewriteCond %{REQUEST_FILENAME}/OPEN-EULA.txt -f 
RewriteRule .* - [L]

RewriteCond %{REQUEST_FILENAME} -f
RewriteCond %{ENV:LP_DOWNLOAD_DIR}/OPEN-EULA.txt -f 
RewriteRule .* - [L]

## Unset cookie indicating redirect from license.php
## and redirect to reqested locations with status
RewriteCond %{HTTP_COOKIE} redirectlicensephp=403
RewriteRule .* - [CO=redirectlicensephp:INVALID:.%{ENV:CO_DOMAIN}:-1,L,F]

RewriteCond %{HTTP_COOKIE} redirectlicensephp=200 [OR]
RewriteCond %{HTTP_COOKIE} redirectlicensephp=404
RewriteRule .* - [CO=redirectlicensephp:INVALID:.%{ENV:CO_DOMAIN}:-1,L]

## Redirect to the license file protected builds.
RewriteCond %{REQUEST_URI} !^/$ 
RewriteRule .* /licenses/license.php [CO=downloadrequested:%{REQUEST_URI}:.%{ENV:CO_DOMAIN}:5:/,L,R]

## Return "Permission denied" if no EULA/OPEN-EULA/BUILD-INFO exists
RewriteCond %{REQUEST_URI} !^/$
RewriteCond %{REQUEST_URI} !^/licenses/.*$
RewriteCond %{ENV:LP_DOWNLOAD_DIR}/EULA.txt !-f
RewriteCond %{ENV:LP_DOWNLOAD_DIR}/OPEN-EULA.txt !-f
RewriteCond %{ENV:LP_DOWNLOAD_DIR}/BUILD-INFO.txt !-f
RewriteRule .* - [R=403,L]
